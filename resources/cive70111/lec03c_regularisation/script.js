class PolynomialRegularizationDemo{constructor(){this.canvas=document.getElementById("plot"),this.overlayCanvas=document.getElementById("overlay-canvas"),this.overlayCtx=this.overlayCanvas.getContext("2d"),this.chart=null,this.equation=document.getElementById("equation"),this.mseDisplay=new MetricLabel("mse","MSE",{theme:"purple",label:"Mean Squared Error",decimals:0,thousandsSeparator:!0}),this.maeDisplay=new MetricLabel("mae","MAE",{theme:"green",label:"Mean Absolute Error",decimals:2}),this.generateDataBtn=document.getElementById("generate-data-btn"),this.clearDataBtn=document.getElementById("clear-data-btn"),this.degreeSlider=new ParamSlider("paramslider-degree",{inputId:"degree",label:"Polynomial Degree (Max Power)",min:0,max:9,step:1,value:1,fineTuneStep:1,onChange:()=>{this.fitPolynomial(),this.updateDisplay(),this.updateChart()}}),this.l1RegSlider=new ParamSlider("paramslider-l1-reg",{inputId:"l1-reg",label:"L1 Regularisation ($\\lambda_1$)",scale:"log",min:0,max:1e4,value:0,decimals:null,fineTuneStep:1,onChange:()=>{this.fitPolynomial(),this.updateDisplay(),this.updateChart()}}),this.l2RegSlider=new ParamSlider("paramslider-l2-reg",{inputId:"l2-reg",label:"L2 Regularisation ($\\lambda_2$)",scale:"log",min:0,max:1e4,value:0,decimals:null,fineTuneStep:1,onChange:()=>{this.fitPolynomial(),this.updateDisplay(),this.updateChart()}}),this.showSquaresCheckbox=document.getElementById("show-squares"),this.xMin=-10,this.xMax=10,this.yMin=-100,this.yMax=100,this.generateTruePolynomial(),this.generateDataPoints(),this.coefficients=[],this.initializeChart();const{ctx:ctx,dpr:dpr,displayWidth:displayWidth,displayHeight:displayHeight}=CanvasHelper.setupOverlay(this.overlayCanvas,this.canvas);this.overlayCtx=ctx,this.dpr=dpr,this.displayWidth=displayWidth,this.displayHeight=displayHeight,this.setupEventListeners(),this.initializeDisplay(),this.infotab=new InfoTab}generateTruePolynomial(){this.trueCoefficients=[60*(Math.random()-.5),8*(Math.random()-.5),2*(Math.random()-.5),.4*(Math.random()-.5)]}generateDataPoints(){this.dataPoints=[];for(let i=0;i<5;i++){let x,y,attempts=0;do{x=18*(Math.random()-.5);y=this.trueCoefficients[0]+this.trueCoefficients[1]*x+this.trueCoefficients[2]*x*x+this.trueCoefficients[3]*x*x*x+8*(Math.random()-.5)*2,attempts++}while((y<this.yMin||y>this.yMax)&&attempts<50);attempts>=50&&(y=Math.max(this.yMin+10,Math.min(this.yMax-10,y))),this.dataPoints.push({x:x,y:y})}}initializeChart(){this.chart=new Chart(this.canvas.getContext("2d"),{type:"scatter",data:{datasets:[{label:"Data Points",data:[],backgroundColor:"#ff6b6b",borderColor:"#d63447",borderWidth:2,pointRadius:5,pointHoverRadius:7,showLine:!1},{label:"Polynomial Fit",data:[],backgroundColor:"transparent",borderColor:"#4ecdc4",borderWidth:2,pointRadius:0,pointHoverRadius:0,showLine:!0,fill:!1,tension:0,spanGaps:!1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{type:"linear",position:"center",min:this.xMin,max:this.xMax,title:{display:!0,text:"X"},grid:{color:"#e0e0e0"}},y:{type:"linear",position:"center",min:this.yMin,max:this.yMax,title:{display:!0,text:"Y"},grid:{color:"#e0e0e0"}}},plugins:{legend:{display:!0,position:"top"},tooltip:{filter:tooltipItem=>0===tooltipItem.datasetIndex}},onClick:(event,activeElements)=>{this.handleChartClick(event)},animation:{duration:0}}})}initializeDisplay(){this.fitPolynomial(),this.updateChart(),this.updateDisplayPlainText(),window.MathJax&&(MathJax.startup&&MathJax.startup.promise?MathJax.startup.promise.then(()=>{this.updateDisplay()}).catch(()=>{console.warn("MathJax failed to load, using plain text equations")}):setTimeout(()=>{this.updateDisplay()},100))}getSelectedPowers(){const degree=parseInt(this.degreeSlider.value),selectedPowers=[];for(let i=0;i<=degree;i++)selectedPowers.push(i);return selectedPowers}createDesignMatrix(dataPoints,powers){const n=dataPoints.length,p=powers.length,X=[];for(let i=0;i<n;i++){const row=[],x=dataPoints[i].x;for(let j=0;j<p;j++){const power=powers[j];row.push(Math.pow(x,power))}X.push(row)}return X}fitPolynomial(){if(0===this.dataPoints.length)return void(this.coefficients=[]);const selectedPowers=this.getSelectedPowers();if(0===selectedPowers.length)return void(this.coefficients=[]);const X=this.createDesignMatrix(this.dataPoints,selectedPowers),y=this.dataPoints.map(point=>point.y),l1Lambda=parseFloat(this.l1RegSlider.value),l2Lambda=parseFloat(this.l2RegSlider.value);try{this.coefficients=this.solveRegularizedNormalEquations(X,y,l1Lambda,l2Lambda),this.selectedPowers=selectedPowers}catch(error){console.warn("Matrix inversion failed, using zero coefficients"),this.coefficients=new Array(selectedPowers.length).fill(0),this.selectedPowers=selectedPowers}}solveNormalEquations(X,y){const XT=LinAlg.transpose(X),XTX=LinAlg.multiply(XT,X),XTy=LinAlg.vectorMultiply(XT,y);return LinAlg.gaussianElimination(XTX,XTy)}solveRegularizedNormalEquations(X,y,l1Lambda,l2Lambda){return 0===l1Lambda?this.solveRidgeRegression(X,y,l2Lambda):this.solveElasticNet(X,y,l1Lambda,l2Lambda)}solveRidgeRegression(X,y,l2Lambda){const XT=LinAlg.transpose(X),XTX=LinAlg.multiply(XT,X);for(let i=0;i<XTX.length;i++)XTX[i][i]+=l2Lambda;const XTy=LinAlg.vectorMultiply(XT,y);return LinAlg.gaussianElimination(XTX,XTy)}solveElasticNet(X,y,l1Lambda,l2Lambda){const n=X.length,p=X[0].length;let coefficients=new Array(p).fill(0);for(let iter=0;iter<100;iter++){let maxChange=0;for(let j=0;j<p;j++){const oldCoeff=coefficients[j];let partialResidual=0;for(let i=0;i<n;i++){let prediction=0;for(let k=0;k<p;k++)k!==j&&(prediction+=coefficients[k]*X[i][k]);partialResidual+=X[i][j]*(y[i]-prediction)}let sumSquares=0;for(let i=0;i<n;i++)sumSquares+=X[i][j]*X[i][j];coefficients[j]=partialResidual>l1Lambda?(partialResidual-l1Lambda)/(sumSquares+l2Lambda):partialResidual<-l1Lambda?(partialResidual+l1Lambda)/(sumSquares+l2Lambda):0,maxChange=Math.max(maxChange,Math.abs(coefficients[j]-oldCoeff))}if(maxChange<1e-6)break}for(let j=0;j<coefficients.length;j++)Math.abs(coefficients[j])<.5&&(coefficients[j]=0);return coefficients}evaluatePolynomial(x){if(!this.coefficients||0===this.coefficients.length)return 0;let result=0;for(let i=0;i<this.coefficients.length;i++){const power=this.selectedPowers[i];result+=this.coefficients[i]*Math.pow(x,power)}return result}setupEventListeners(){this.showSquaresCheckbox.addEventListener("change",()=>{this.updateOverlay()});const visualizationBox=document.querySelector(".visualization-box");visualizationBox&&(visualizationBox.addEventListener("click",()=>{this.showSquaresCheckbox.checked=!this.showSquaresCheckbox.checked,visualizationBox.classList.toggle("active",this.showSquaresCheckbox.checked),this.updateOverlay()}),visualizationBox.classList.toggle("active",this.showSquaresCheckbox.checked)),this.generateDataBtn.addEventListener("click",()=>{this.generateNewData()}),this.clearDataBtn.addEventListener("click",()=>{this.clearAllData()})}updateDisplay(){const l1Lambda=parseFloat(this.l1RegSlider.value),l2Lambda=parseFloat(this.l2RegSlider.value),X=this.createDesignMatrix(this.dataPoints,this.selectedPowers),y=this.dataPoints.map(point=>point.y);let unregularizedCoeffs=[];if(this.dataPoints.length>0&&this.selectedPowers.length>0)try{unregularizedCoeffs=this.solveRidgeRegression(X,y,0)}catch(error){unregularizedCoeffs=new Array(this.selectedPowers.length).fill(0)}const tableBody=document.getElementById("coefficientsBody");if(tableBody.innerHTML="",this.coefficients&&this.coefficients.length>0){const varRow=document.createElement("tr"),varHeader=document.createElement("th");varHeader.textContent="Variable",varRow.appendChild(varHeader);for(let i=0;i<this.coefficients.length;i++){const power=this.selectedPowers[i],td=document.createElement("td");let variableName;td.className="var-badge",variableName=0===power?"1":1===power?"x":`x^{${power}}`,td.innerHTML=`$${variableName}$`,varRow.appendChild(td)}tableBody.appendChild(varRow);const unregRow=document.createElement("tr"),unregHeader=document.createElement("th");unregHeader.innerHTML="Unregularized $a_i^0$",unregRow.appendChild(unregHeader);for(let i=0;i<this.coefficients.length;i++){const unregCoeff=unregularizedCoeffs[i]||0,td=document.createElement("td");Math.abs(unregCoeff)<.001?(td.className="unreg-value zero-dash",td.textContent="—"):(td.className="unreg-value",td.textContent=unregCoeff.toFixed(3)),unregRow.appendChild(td)}tableBody.appendChild(unregRow);const l1Row=document.createElement("tr"),l1Header=document.createElement("th");l1Header.innerHTML="L1 Penalty $\\lambda_1|a_i^0|$",l1Row.appendChild(l1Header);for(let i=0;i<this.coefficients.length;i++){const unregCoeff=unregularizedCoeffs[i]||0,l1Penalty=l1Lambda*Math.abs(unregCoeff),td=document.createElement("td");l1Penalty<.001?(td.className="l1-penalty zero-dash",td.textContent="—"):(td.className="l1-penalty",td.textContent=l1Penalty.toFixed(3)),l1Row.appendChild(td)}tableBody.appendChild(l1Row);const l2Row=document.createElement("tr"),l2Header=document.createElement("th");l2Header.innerHTML="L2 Penalty $\\lambda_2 (a_i^0)^2$",l2Row.appendChild(l2Header);for(let i=0;i<this.coefficients.length;i++){const unregCoeff=unregularizedCoeffs[i]||0,l2Penalty=l2Lambda*unregCoeff*unregCoeff,td=document.createElement("td");l2Penalty<.001?(td.className="l2-penalty zero-dash",td.textContent="—"):(td.className="l2-penalty",td.textContent=l2Penalty.toFixed(3)),l2Row.appendChild(td)}tableBody.appendChild(l2Row);const effRow=document.createElement("tr"),effHeader=document.createElement("th");effHeader.innerHTML="Effective $a_i$",effRow.appendChild(effHeader);for(let i=0;i<this.coefficients.length;i++){const coeff=this.coefficients[i],td=document.createElement("td");Math.abs(coeff)<.001?(td.className="eff-value zero-dash",td.textContent="—"):(td.className="eff-value",td.textContent=coeff.toFixed(3)),effRow.appendChild(td)}tableBody.appendChild(effRow);const deltaRow=document.createElement("tr"),deltaHeader=document.createElement("th");deltaHeader.innerHTML="$\\Delta |a_i|$",deltaRow.appendChild(deltaHeader);for(let i=0;i<this.coefficients.length;i++){const coeff=this.coefficients[i],unregCoeff=unregularizedCoeffs[i]||0,td=document.createElement("td"),delta=Math.abs(coeff)-Math.abs(unregCoeff);Math.abs(unregCoeff)<.001?Math.abs(coeff)<.001?(td.textContent="—",td.className="delta-value neutral zero-dash"):(td.textContent="+"+Math.abs(coeff).toFixed(3),td.className="delta-value growth"):Math.abs(delta)<.001?(td.textContent="—",td.className="delta-value neutral zero-dash"):delta<0?(td.className="delta-value shrinkage",td.textContent=delta.toFixed(3)):(td.className="delta-value growth",td.textContent="+"+delta.toFixed(3)),deltaRow.appendChild(td)}tableBody.appendChild(deltaRow);let unregL1=0,unregL2=0;for(let i=0;i<unregularizedCoeffs.length;i++)unregL1+=Math.abs(unregularizedCoeffs[i]),unregL2+=unregularizedCoeffs[i]*unregularizedCoeffs[i];unregL2=Math.sqrt(unregL2);let effL1=0,effL2=0;for(let i=0;i<this.coefficients.length;i++)effL1+=Math.abs(this.coefficients[i]),effL2+=this.coefficients[i]*this.coefficients[i];effL2=Math.sqrt(effL2);const l1Display=document.getElementById("l1-norm-display"),l1Box=document.querySelector('[data-visualization="l1-norm"]');l1Display&&l1Box&&(l1Lambda>0?(l1Display.textContent=`${unregL1.toFixed(2)} → ${effL1.toFixed(2)}`,l1Display.style.display="block",l1Box.classList.add("active")):(l1Display.textContent="",l1Display.style.display="none",l1Box.classList.remove("active")));const l2Display=document.getElementById("l2-norm-display"),l2Box=document.querySelector('[data-visualization="l2-norm"]');l2Display&&l2Box&&(l2Lambda>0?(l2Display.textContent=`${unregL2.toFixed(2)} → ${effL2.toFixed(2)}`,l2Display.style.display="block",l2Box.classList.add("active")):(l2Display.textContent="",l2Display.style.display="none",l2Box.classList.remove("active")))}let equationText="y = ";if(this.coefficients&&0!==this.coefficients.length){const terms=[];let hasNonZeroTerms=!1;for(let i=0;i<this.coefficients.length;i++){const coeff=this.coefficients[i],power=this.selectedPowers[i];if(Math.abs(coeff)<.001)continue;hasNonZeroTerms=!0;let term="";const absCoeff=Math.abs(coeff),sign=coeff>=0?"+":"-";term=0===terms.length?0===power?coeff.toFixed(3):1===power?`${coeff.toFixed(3)}x`:`${coeff.toFixed(3)}x^{${power}}`:0===power?`${sign} ${absCoeff.toFixed(3)}`:1===power?`${sign} ${absCoeff.toFixed(3)}x`:`${sign} ${absCoeff.toFixed(3)}x^{${power}}`,terms.push(term)}hasNonZeroTerms?equationText+=terms.join(" "):equationText="y = 0"}else equationText="y = 0";this.equation.innerHTML=`$$${equationText}$$`,window.MathJax&&window.MathJax.typesetPromise&&MathJax.typesetPromise([this.equation,tableBody]).catch(err=>console.log(err));const yTrue=this.dataPoints.map(p=>p.y),yPred=this.dataPoints.map(p=>this.evaluatePolynomial(p.x)),mse=Metrics.mse(yTrue,yPred),mae=Metrics.mae(yTrue,yPred);this.mseDisplay.update(mse),this.maeDisplay.update(mae)}updateDisplayPlainText(){let equationText="y = ";if(this.coefficients&&0!==this.coefficients.length){const terms=[];let hasNonZeroTerms=!1;for(let i=0;i<this.coefficients.length;i++){const coeff=this.coefficients[i],power=this.selectedPowers[i];if(Math.abs(coeff)<.001)continue;hasNonZeroTerms=!0;let term="";const absCoeff=Math.abs(coeff),sign=coeff>=0?"+":"-";term=0===terms.length?0===power?coeff.toFixed(3):1===power?`${coeff.toFixed(3)}x`:`${coeff.toFixed(3)}x^${power}`:0===power?`${sign} ${absCoeff.toFixed(3)}`:1===power?`${sign} ${absCoeff.toFixed(3)}x`:`${sign} ${absCoeff.toFixed(3)}x^${power}`,terms.push(term)}hasNonZeroTerms?equationText+=terms.join(" "):equationText="y = 0"}else equationText="y = 0";this.equation.textContent=equationText;const yTrue=this.dataPoints.map(p=>p.y),yPred=this.dataPoints.map(p=>this.evaluatePolynomial(p.x)),mse=Metrics.mse(yTrue,yPred),mae=Metrics.mae(yTrue,yPred);this.mseDisplay.update(mse),this.maeDisplay.update(mae)}generateNewData(){this.generateTruePolynomial(),this.clearAllData(),this.generateDataPoints(),this.fitPolynomial(),this.updateDisplay(),this.updateChart()}clearAllData(){this.dataPoints=[],this.fitPolynomial(),this.updateDisplay(),this.updateChart()}handleChartClick(event){const canvasPosition=Chart.helpers.getRelativePosition(event,this.chart),x=this.chart.scales.x.getValueForPixel(canvasPosition.x),y=this.chart.scales.y.getValueForPixel(canvasPosition.y);x>=this.xMin&&x<=this.xMax&&y>=this.yMin&&y<=this.yMax&&(this.dataPoints.push({x:x,y:y}),this.fitPolynomial(),this.updateDisplay(),this.updateChart())}updateChart(){this.chart&&(this.chart.data.datasets[0].data=this.dataPoints.map(point=>({x:point.x,y:point.y})),this.chart.data.datasets[1].data=this.generatePolynomialCurveData(),this.chart.update("none"),this.updateOverlay())}generatePolynomialCurveData(){if(!this.coefficients||0===this.coefficients.length)return[];const curvePoints=[],stepSize=(this.xMax-this.xMin)/7500;for(let i=0;i<=7500;i++){const x=this.xMin+i*stepSize,y=this.evaluatePolynomial(x);y>=this.yMin&&y<=this.yMax?curvePoints.push({x:x,y:y}):curvePoints.push({x:x,y:null})}return curvePoints}updateOverlay(){if(!this.overlayCtx)return;this.overlayCtx.clearRect(0,0,this.displayWidth,this.displayHeight);this.dataPoints.length>0&&this.coefficients.length>0&&this.showSquaresCheckbox.checked?(this.overlayCanvas.style.visibility="visible",this.drawErrorSquares(),this.drawErrorLines()):this.overlayCanvas.style.visibility="hidden"}dataToOverlayCanvas(x,y){if(!this.chart||!this.chart.scales)return{x:0,y:0};return{x:this.chart.scales.x.getPixelForValue(x),y:this.chart.scales.y.getPixelForValue(y)}}drawErrorLines(){this.overlayCtx.strokeStyle="#777777",this.overlayCtx.lineWidth=1,this.overlayCtx.setLineDash([2,2]),this.dataPoints.forEach(point=>{const predicted=this.evaluatePolynomial(point.x),pointCanvas=this.dataToOverlayCanvas(point.x,point.y),predictedCanvas=this.dataToOverlayCanvas(point.x,predicted);this.overlayCtx.beginPath(),this.overlayCtx.moveTo(pointCanvas.x,pointCanvas.y),this.overlayCtx.lineTo(predictedCanvas.x,predictedCanvas.y),this.overlayCtx.stroke()}),this.overlayCtx.setLineDash([])}drawErrorSquares(){this.coefficients&&0!==this.coefficients.length&&(this.overlayCtx.fillStyle="rgba(231, 76, 60, 0.15)",this.overlayCtx.strokeStyle="rgba(231, 76, 60, 0.25)",this.overlayCtx.lineWidth=1,this.dataPoints.forEach(point=>{const predicted=this.evaluatePolynomial(point.x),error=point.y-predicted,pointCanvas=this.dataToOverlayCanvas(point.x,point.y),predictedCanvas=this.dataToOverlayCanvas(point.x,predicted),squareSizePixels=Math.abs(pointCanvas.y-predictedCanvas.y);squareSizePixels>2&&(this.overlayCtx.beginPath(),error>0?this.overlayCtx.rect(predictedCanvas.x,predictedCanvas.y,squareSizePixels,-squareSizePixels):this.overlayCtx.rect(predictedCanvas.x,predictedCanvas.y,squareSizePixels,squareSizePixels),this.overlayCtx.fill(),this.overlayCtx.stroke())}))}}document.addEventListener("DOMContentLoaded",()=>{new PolynomialRegularizationDemo});
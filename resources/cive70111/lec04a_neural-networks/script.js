class NeuralNetworkDemo{constructor(){this.networkContainer=document.getElementById("network-container"),this.layerControls=document.getElementById("layer-controls"),this.addLayerBtn=document.getElementById("add-layer-btn"),this.removeLayerBtn=document.getElementById("remove-layer-btn"),this.randomInputsBtn=document.getElementById("random-inputs-btn"),this.randomiseWeightsBtn=document.getElementById("randomise-weights-btn"),this.input1Slider=new ParamSlider("paramslider-input1",{inputId:"input1",label:"Input 1",min:-5,max:5,step:.1,value:1,decimals:1,onChange:()=>this.updateNetwork()}),this.input2Slider=new ParamSlider("paramslider-input2",{inputId:"input2",label:"Input 2",min:-5,max:5,step:.1,value:.5,decimals:1,onChange:()=>this.updateNetwork()}),this.input3Slider=new ParamSlider("paramslider-input3",{inputId:"input3",label:"Input 3",min:-5,max:5,step:.1,value:-1,decimals:1,onChange:()=>this.updateNetwork()}),this.layers=[{type:"input",units:3,activation:"linear"},{type:"hidden",units:4,activation:"relu"},{type:"hidden",units:3,activation:"relu"},{type:"output",units:1,activation:"sigmoid"}],this.weights=[],this.biases=[],this.layerValues=[],this.preActivationValues=[],this.selectedNode=null,this.animationActive=!1,this.initializeNetwork(),this.setupEventListeners(),this.infotab=new InfoTab,this.renderLayerControls(),this.updateLayerButtons(),this.renderNetwork(),this.updateNetwork()}initializeNetwork(){this.weights=[],this.biases=[];for(let i=0;i<this.layers.length-1;i++){const currentLayer=this.layers[i],nextLayer=this.layers[i+1],layerWeights=[];for(let j=0;j<nextLayer.units;j++){const neuronWeights=[];for(let k=0;k<currentLayer.units;k++)neuronWeights.push(2*(Math.random()-.5));layerWeights.push(neuronWeights)}this.weights.push(layerWeights);const layerBiases=[];for(let j=0;j<nextLayer.units;j++)layerBiases.push(2*(Math.random()-.5));this.biases.push(layerBiases)}}setupEventListeners(){this.addLayerBtn.addEventListener("click",()=>this.addLayer()),this.removeLayerBtn.addEventListener("click",()=>this.removeLayer()),this.randomInputsBtn.addEventListener("click",()=>this.generateRandomInputs()),this.randomiseWeightsBtn.addEventListener("click",()=>this.randomiseWeights())}addLayer(){if(this.layers.filter(layer=>"hidden"===layer.type).length>=3)return;this.layers.splice(this.layers.length-1,0,{type:"hidden",units:3,activation:"relu"}),this.initializeNetwork(),this.renderLayerControls(),this.renderNetwork(),this.updateNetwork(),this.updateLayerButtons()}removeLayer(){this.layers.length>2&&(this.layers.splice(this.layers.length-2,1),this.initializeNetwork(),this.renderLayerControls(),this.renderNetwork(),this.updateNetwork(),this.updateLayerButtons())}generateRandomInputs(){const value1=8*(Math.random()-.5),value2=8*(Math.random()-.5),value3=8*(Math.random()-.5);this.input1Slider.setValue(value1),this.input2Slider.setValue(value2),this.input3Slider.setValue(value3),this.updateNetwork()}randomiseWeights(){this.initializeNetwork(),this.renderNetwork(),this.updateNetwork()}updateLayerButtons(){const hiddenLayerCount=this.layers.filter(layer=>"hidden"===layer.type).length;this.addLayerBtn.disabled=hiddenLayerCount>=3,this.removeLayerBtn.disabled=hiddenLayerCount<=0}renderLayerControls(){this.layerControls.innerHTML="",this.layers.forEach((layer,index)=>{if("input"===layer.type)return;const controlGroup=document.createElement("div");controlGroup.className="layer-control-group";const layerName="output"===layer.type?"Output Layer":`Hidden Layer ${index}`;controlGroup.innerHTML=`\n                <div class="layer-label">${layerName}</div>\n                <div class="layer-controls-row">\n                    <div class="layer-control-item">\n                        <label>Units:</label>\n                        <input type="number" min="1" max="6" value="${layer.units}"\n                               onchange="demo.updateLayerUnits(${index}, this.value)">\n                    </div>\n                    <div class="layer-control-item">\n                        <label>Activation:</label>\n                        <select onchange="demo.updateLayerActivation(${index}, this.value)">\n                            <option value="linear" ${"linear"===layer.activation?"selected":""}>Linear</option>\n                            <option value="relu" ${"relu"===layer.activation?"selected":""}>ReLU</option>\n                            <option value="sigmoid" ${"sigmoid"===layer.activation?"selected":""}>Sigmoid</option>\n                            <option value="tanh" ${"tanh"===layer.activation?"selected":""}>Tanh</option>\n                        </select>\n                    </div>\n                </div>\n            `,this.layerControls.appendChild(controlGroup)})}updateLayerUnits(layerIndex,units){const newUnits=Math.max(1,Math.min(6,parseInt(units)));this.layers[layerIndex].units=newUnits,this.initializeNetwork(),this.renderNetwork(),this.updateNetwork()}updateLayerActivation(layerIndex,activation){this.layers[layerIndex].activation=activation,this.renderNetwork(),this.updateNetwork()}getActivationIcon(activation){const iconMap={linear:'<svg viewBox="0 0 20 10"><line x1="0" y1="10" x2="20" y2="0" stroke="#666" stroke-width="1.5" fill="none"/></svg>',relu:'<svg viewBox="0 0 20 10"><path d="M 0 10 L 10 10 L 20 0" stroke="#666" stroke-width="1.5" fill="none"/></svg>',sigmoid:'<svg viewBox="0 0 20 10"><path d="M 0 9 Q 5 9, 10 5 T 20 1" stroke="#666" stroke-width="1.5" fill="none"/></svg>',tanh:'<svg viewBox="0 0 20 10"><path d="M 0 8 Q 5 8, 10 5 T 20 2" stroke="#666" stroke-width="1.5" fill="none"/></svg>'};return iconMap[activation]||iconMap.linear}renderNetwork(){this.networkContainer.innerHTML="";const containerWidth=this.networkContainer.clientWidth-10,containerHeight=this.networkContainer.clientHeight-10,layerSpacing=(containerHeight-60-80)/(this.layers.length-1);this.nodePositions=[],this.layers.forEach((layer,layerIndex)=>{const layerPositions=[],maxUnits=Math.max(...this.layers.map(l=>l.units)),nodeSpacing=containerWidth/(maxUnits+1),layerStartX=(containerWidth-(layer.units-1)*nodeSpacing)/2,y=60+layerIndex*layerSpacing-20,layerLabel=document.createElement("div");layerLabel.className="network-layer-label-vertical",layerLabel.style.top=`${y+30}px`,layerLabel.style.left="10px";let labelText="";if("input"===layer.type)labelText="Input";else if("output"===layer.type)labelText="Output";else{let hiddenCount=0;for(let i=1;i<layerIndex;i++)"hidden"===this.layers[i].type&&hiddenCount++;labelText=`Hidden ${hiddenCount+1}`}layerLabel.textContent=labelText,this.networkContainer.appendChild(layerLabel);for(let nodeIndex=0;nodeIndex<layer.units;nodeIndex++){const node=document.createElement("div");node.className=`network-node ${layer.type}`;const x=layerStartX+nodeIndex*nodeSpacing,y=60+layerIndex*layerSpacing-20;if(node.style.left=`${x}px`,node.style.top=`${y}px`,"input"!==layer.type){const iconDiv=document.createElement("div");iconDiv.className="activation-icon",iconDiv.innerHTML=this.getActivationIcon(layer.activation),node.appendChild(iconDiv)}else{const valueSpan=document.createElement("span");valueSpan.style.background="white",valueSpan.style.border="1px solid white",valueSpan.style.borderRadius="3px",valueSpan.style.padding="1px 3px",valueSpan.style.fontSize="14px",valueSpan.style.fontWeight="bold",valueSpan.style.fontFamily="monospace",valueSpan.style.zIndex="10",valueSpan.style.position="relative",valueSpan.textContent="0.00",valueSpan.id=`value-${layerIndex}-${nodeIndex}`,valueSpan.style.color="#1976d2",node.appendChild(valueSpan)}if("input"!==layer.type){const outputLabel=document.createElement("div");outputLabel.className="node-output-label",outputLabel.style.left=`${x+5}px`,outputLabel.style.top=`${y+75}px`,outputLabel.textContent="0.00",outputLabel.id=`output-${layerIndex}-${nodeIndex}`,this.networkContainer.appendChild(outputLabel)}layerIndex>0&&node.addEventListener("click",()=>this.openWeightModal(layerIndex,nodeIndex)),node.addEventListener("mouseenter",e=>this.showNodeTooltip(e,layerIndex,nodeIndex)),node.addEventListener("mouseleave",()=>this.hideNodeTooltip()),layerPositions.push({x:x+30,y:y+30}),this.networkContainer.appendChild(node)}this.nodePositions.push(layerPositions)}),this.drawConnections()}drawConnections(){document.querySelectorAll(".network-edge").forEach(edge=>edge.remove());for(let layerIndex=0;layerIndex<this.layers.length-1;layerIndex++){const currentPositions=this.nodePositions[layerIndex],nextPositions=this.nodePositions[layerIndex+1],allWeights=this.weights[layerIndex].flat(),maxWeight=Math.max(...allWeights),minWeight=Math.min(...allWeights);currentPositions.forEach((fromPos,fromIndex)=>{nextPositions.forEach((toPos,toIndex)=>{const edge=document.createElement("div");edge.className="network-edge";const dx=toPos.x-fromPos.x,dy=toPos.y-fromPos.y,length=Math.sqrt(dx*dx+dy*dy),angle=Math.atan2(dy,dx);edge.style.left=`${fromPos.x}px`,edge.style.top=`${fromPos.y}px`,edge.style.width=`${length}px`,edge.style.transform=`rotate(${angle}rad)`;const weight=this.weights[layerIndex][toIndex][fromIndex],color=this.getColorForValue(weight,minWeight,maxWeight);edge.style.background=color,edge.style.opacity=1,edge.dataset.layerIndex=layerIndex,edge.dataset.fromIndex=fromIndex,edge.dataset.toIndex=toIndex,edge.addEventListener("mouseenter",e=>this.showEdgeTooltip(e,layerIndex,fromIndex,toIndex)),edge.addEventListener("mouseleave",()=>this.hideEdgeTooltip()),this.networkContainer.appendChild(edge)})})}}updateNetwork(){const inputs=[this.input1Slider.getValue(),this.input2Slider.getValue(),this.input3Slider.getValue()];this.layerValues=[inputs],this.preActivationValues=[inputs];for(let i=0;i<this.layers.length-1;i++){const currentValues=this.layerValues[i],layerWeights=this.weights[i],layerBiases=this.biases[i],activation=this.layers[i+1].activation,nextPreActivationValues=[],nextValues=[];for(let j=0;j<layerWeights.length;j++){let sum=layerBiases[j];for(let k=0;k<currentValues.length;k++)sum+=currentValues[k]*layerWeights[j][k];nextPreActivationValues.push(sum),nextValues.push(this.applyActivation(sum,activation))}this.preActivationValues.push(nextPreActivationValues),this.layerValues.push(nextValues)}this.updateNodeColors(),this.updateConnectionColors()}applyActivation(x,activation){switch(activation){case"linear":default:return x;case"relu":return Math.max(0,x);case"sigmoid":return 1/(1+Math.exp(-x));case"tanh":return Math.tanh(x)}}getColorForValue(value,min,max){if(min===max)return value>=0?"#4caf50":"#f44336";let normalizedValue;if(value>=0){normalizedValue=max>0?value/max:0;return`rgb(${Math.round(200-124*normalizedValue)}, ${Math.round(230-55*normalizedValue)}, ${Math.round(201-121*normalizedValue)})`}normalizedValue=min<0?value/min:0;return`rgb(${Math.round(255-11*normalizedValue)}, ${Math.round(205-154*normalizedValue)}, ${Math.round(210-156*normalizedValue)})`}updateConnectionColors(){document.querySelectorAll(".network-edge").forEach(edge=>{const layerIndex=parseInt(edge.dataset.layerIndex),fromIndex=parseInt(edge.dataset.fromIndex),toIndex=parseInt(edge.dataset.toIndex),transmittedValue=this.layerValues[layerIndex][fromIndex]*this.weights[layerIndex][toIndex][fromIndex],layerTransmittedValues=[];for(let to=0;to<this.weights[layerIndex].length;to++)for(let from=0;from<this.weights[layerIndex][to].length;from++){const src=this.layerValues[layerIndex][from],w=this.weights[layerIndex][to][from];layerTransmittedValues.push(src*w)}const minTransmitted=Math.min(...layerTransmittedValues),maxTransmitted=Math.max(...layerTransmittedValues),color=this.getColorForValue(transmittedValue,minTransmitted,maxTransmitted);edge.style.background=color})}updateNodeColors(){const layerValueRanges=this.layerValues.map(values=>({min:Math.min(...values),max:Math.max(...values)}));this.layerValues.forEach((values,layerIndex)=>{values.forEach((value,valueIndex)=>{const valueSpan=document.getElementById(`value-${layerIndex}-${valueIndex}`);valueSpan&&(valueSpan.textContent=value.toFixed(2),valueSpan.style.background="white",valueSpan.style.border="1px solid white",0===layerIndex?valueSpan.style.color="#1976d2":layerIndex===this.layers.length-1?valueSpan.style.color="#388e3c":valueSpan.style.color="#7b1fa2");const nodes=document.querySelectorAll(".network-node");let nodeIndex=0;for(let i=0;i<layerIndex;i++)nodeIndex+=this.layers[i].units;nodeIndex+=valueIndex;const node=nodes[nodeIndex];if(node){let color;if(0===layerIndex)color=this.getColorForValue(value,-5,5);else{const valueRange=layerValueRanges[layerIndex];color=this.getColorForValue(value,valueRange.min,valueRange.max)}node.style.boxShadow=`inset 0 0 0 6px ${color}`}const outputLabel=document.getElementById(`output-${layerIndex}-${valueIndex}`);outputLabel&&(outputLabel.textContent=value.toFixed(2))})})}openWeightModal(layerIndex,nodeIndex){const modal=document.getElementById("weight-modal"),modalTitle=document.getElementById("modal-title"),modalWeights=document.getElementById("modal-weights");this.selectedNode={layerIndex:layerIndex,nodeIndex:nodeIndex};const layerName="output"===this.layers[layerIndex].type?"Output":`Hidden Layer ${layerIndex}`;modalTitle.textContent=`Edit Weights - ${layerName} Node ${nodeIndex+1}`,modalWeights.innerHTML="";const weights=this.weights[layerIndex-1][nodeIndex],bias=this.biases[layerIndex-1][nodeIndex];weights.forEach((weight,index)=>{const inputGroup=document.createElement("div");inputGroup.style.marginBottom="10px",inputGroup.innerHTML=`\n                <label style="display: inline-block; width: 120px;">\n                    From Input ${index+1}:\n                </label>\n                <input type="number" class="weight-input" value="${weight.toFixed(3)}" \n                       step="0.01" data-weight-index="${index}">\n            `,modalWeights.appendChild(inputGroup)});const biasGroup=document.createElement("div");biasGroup.style.marginBottom="10px",biasGroup.innerHTML=`\n            <label style="display: inline-block; width: 120px;">\n                Bias:\n            </label>\n            <input type="number" class="weight-input" value="${bias.toFixed(3)}" \n                   step="0.01" id="bias-input">\n        `,modalWeights.appendChild(biasGroup),modalWeights.querySelectorAll(".weight-input").forEach(input=>{input.addEventListener("input",()=>this.updateWeights())}),modal.style.display="flex"}updateWeights(){if(!this.selectedNode)return;const{layerIndex:layerIndex,nodeIndex:nodeIndex}=this.selectedNode,weightInputs=document.querySelectorAll(".weight-input[data-weight-index]"),biasInput=document.getElementById("bias-input");weightInputs.forEach((input,index)=>{this.weights[layerIndex-1][nodeIndex][index]=parseFloat(input.value)}),biasInput&&(this.biases[layerIndex-1][nodeIndex]=parseFloat(biasInput.value)),this.drawConnections(),this.updateNetwork()}closeWeightModal(){document.getElementById("weight-modal").style.display="none",this.selectedNode=null}randomizeWeights(){if(!this.selectedNode)return;const{layerIndex:layerIndex,nodeIndex:nodeIndex}=this.selectedNode,weightInputs=document.querySelectorAll(".weight-input[data-weight-index]"),biasInput=document.getElementById("bias-input");if(weightInputs.forEach((input,index)=>{const newWeight=2*(Math.random()-.5);input.value=newWeight.toFixed(3),this.weights[layerIndex-1][nodeIndex][index]=newWeight}),biasInput){const newBias=2*(Math.random()-.5);biasInput.value=newBias.toFixed(3),this.biases[layerIndex-1][nodeIndex]=newBias}this.drawConnections(),this.updateNetwork()}showEdgeTooltip(event,layerIndex,fromIndex,toIndex){const weight=this.weights[layerIndex][toIndex][fromIndex],sourceValue=this.layerValues[layerIndex][fromIndex],transmittedValue=sourceValue*weight;let tooltip=document.getElementById("edge-tooltip");tooltip||(tooltip=document.createElement("div"),tooltip.id="edge-tooltip",tooltip.className="edge-tooltip",document.body.appendChild(tooltip)),tooltip.innerHTML=`\n            <div><strong>Weight:</strong> ${weight.toFixed(3)}</div>\n            <div><strong>Input:</strong> ${sourceValue.toFixed(3)}</div>\n            <div><strong>Output:</strong> ${transmittedValue.toFixed(3)}</div>\n        `,tooltip.style.left=`${event.pageX+10}px`,tooltip.style.top=`${event.pageY+10}px`,tooltip.style.display="block"}hideEdgeTooltip(){const tooltip=document.getElementById("edge-tooltip");tooltip&&(tooltip.style.display="none")}showNodeTooltip(event,layerIndex,nodeIndex){let tooltip=document.getElementById("node-tooltip");tooltip||(tooltip=document.createElement("div"),tooltip.id="node-tooltip",tooltip.className="node-tooltip",document.body.appendChild(tooltip));let content="";if(0===layerIndex){content=`\n                <div><strong>Input Node ${nodeIndex+1}</strong></div>\n                <div>Value: ${this.layerValues[layerIndex][nodeIndex].toFixed(3)}</div>\n            `}else{const bias=this.biases[layerIndex-1][nodeIndex],z=this.preActivationValues[layerIndex][nodeIndex],a=this.layerValues[layerIndex][nodeIndex],activation=this.layers[layerIndex].activation,weights=this.weights[layerIndex-1][nodeIndex],prevLayerValues=this.layerValues[layerIndex-1];content=`\n                <div><strong>${"output"===this.layers[layerIndex].type?"Output":`Hidden Layer ${layerIndex}`} Node ${nodeIndex+1}</strong></div>\n                <div style="margin-top: 6px;"><strong>Inputs:</strong></div>\n            `;for(let i=0;i<weights.length;i++){const inputValue=prevLayerValues[i],contribution=inputValue*weights[i];content+=`<div style="margin-left: 10px;">x${i+1} = ${inputValue.toFixed(3)} Ã— w${i+1} = ${contribution.toFixed(3)}</div>`}content+=`\n                <div style="margin-top: 4px;"><strong>Bias:</strong> b = ${bias.toFixed(3)}</div>\n                <div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid #ddd;">\n                    <strong>z</strong> (pre-activation) = ${z.toFixed(3)}\n                </div>\n                <div style="margin-top: 4px;">\n                    <strong>a</strong> (post-activation) = ${activation}(z) = ${a.toFixed(3)}\n                </div>\n            `}tooltip.innerHTML=content,tooltip.style.left=`${event.pageX+15}px`,tooltip.style.top=`${event.pageY+15}px`,tooltip.style.display="block"}hideNodeTooltip(){const tooltip=document.getElementById("node-tooltip");tooltip&&(tooltip.style.display="none")}}function closeWeightModal(){window.demo&&window.demo.closeWeightModal()}function randomizeWeights(){window.demo&&window.demo.randomizeWeights()}document.addEventListener("DOMContentLoaded",()=>{window.demo=new NeuralNetworkDemo});
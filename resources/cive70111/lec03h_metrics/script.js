class MetricsDemo{constructor(){this.canvas=document.getElementById("plotCanvas"),this.ctx=this.canvas.getContext("2d");const dpr=window.devicePixelRatio||1;this.canvas.width=600*dpr,this.canvas.height=500*dpr,this.canvas.style.width="600px",this.canvas.style.height="500px",this.ctx.scale(dpr,dpr),this.weights=[2,0],this.bias=0,this.currentDataset="balanced",this.data=[],this.probabilities=[],this.threshold=.5,this.hoveredCell=null,this.infotab=new InfoTab,this.initializeElements(),this.setupEventListeners(),this.generateDataset(this.currentDataset),this.update()}initializeElements(){this.thresholdSlider=document.getElementById("threshold"),this.thresholdValue=document.getElementById("threshold-value"),this.datasetBoxes=document.querySelectorAll(".fancybox"),this.cmCells=document.querySelectorAll(".cm-cell")}setupEventListeners(){this.thresholdSlider.addEventListener("input",e=>{this.threshold=parseFloat(e.target.value),this.thresholdValue.textContent=this.threshold.toFixed(2),this.update()}),this.datasetBoxes.forEach(box=>{box.addEventListener("click",()=>{this.datasetBoxes.forEach(b=>b.classList.remove("active")),box.classList.add("active"),this.currentDataset=box.dataset.type,this.generateDataset(this.currentDataset),this.update()})}),this.cmCells.forEach(cell=>{cell.addEventListener("mouseenter",()=>{this.hoveredCell=cell.dataset.cell,this.render()}),cell.addEventListener("mouseleave",()=>{this.hoveredCell=null,this.render()})})}generateDataset(scenario){if(this.data=[],this.yJitter=[],"balanced"===scenario){const n0=200,n1=200;for(let i=0;i<n0;i++)this.data.push({x:[this.gaussian(-1,1),this.gaussian(0,.8)],y:0});for(let i=0;i<n1;i++)this.data.push({x:[this.gaussian(1,1),this.gaussian(0,.8)],y:1})}else if("melanoma"===scenario){const n0=1990,n1=10;for(let i=0;i<n0;i++)this.data.push({x:[this.gaussian(-1.5,1),this.gaussian(0,.8)],y:0});for(let i=0;i<n1;i++)this.data.push({x:[this.gaussian(.2,.8),this.gaussian(0,.8)],y:1})}else if("bridge"===scenario){const n0=380,n1=20;for(let i=0;i<n0;i++)this.data.push({x:[this.gaussian(-1.5,1),this.gaussian(0,.8)],y:0});for(let i=0;i<n1;i++)this.data.push({x:[this.gaussian(0,2.5),this.gaussian(0,.8)],y:1})}this.probabilities=this.data.map(point=>this.predict(point.x)),this.yJitter=this.data.map(()=>.4*(Math.random()-.5))}gaussian(mean,std){const u1=Math.random(),u2=Math.random();return Math.sqrt(-2*Math.log(u1))*Math.cos(2*Math.PI*u2)*std+mean}predict(x){const z=this.weights[0]*x[0]+this.weights[1]*x[1]+this.bias;return 1/(1+Math.exp(-z))}computeMetrics(){let TP=0,TN=0,FP=0,FN=0;for(let i=0;i<this.data.length;i++){const yTrue=this.data[i].y,yPred=this.probabilities[i]>=this.threshold?1:0;1===yTrue&&1===yPred?TP++:0===yTrue&&0===yPred?TN++:0===yTrue&&1===yPred?FP++:FN++}const sensitivity=TP/Math.max(TP+FN,1e-12),specificity=TN/Math.max(TN+FP,1e-12),precision=TP/Math.max(TP+FP,1e-12);return{TP:TP,TN:TN,FP:FP,FN:FN,sensitivity:sensitivity,specificity:specificity,precision:precision,accuracy:(TP+TN)/(TP+TN+FP+FN),f1:2*precision*sensitivity/Math.max(precision+sensitivity,1e-12),balancedAcc:(sensitivity+specificity)/2}}update(){const metrics=this.computeMetrics();document.getElementById("count-tp").textContent=metrics.TP,document.getElementById("count-tn").textContent=metrics.TN,document.getElementById("count-fp").textContent=metrics.FP,document.getElementById("count-fn").textContent=metrics.FN,this.updateMetric("sensitivity",metrics.sensitivity),this.updateMetric("specificity",metrics.specificity),this.updateMetric("precision",metrics.precision),this.updateMetric("accuracy",metrics.accuracy),this.updateMetric("f1",metrics.f1),this.updateMetric("balanced",metrics.balancedAcc),this.render()}updateMetric(name,value){const valueEl=document.getElementById(`metric-${name}`),barEl=document.getElementById(`bar-${name}`);valueEl.textContent=(100*value).toFixed(1)+"%",barEl.style.width=100*value+"%"}render(){this.ctx.clearRect(0,0,600,500),this.drawProbabilityBackground(),this.drawThresholdLine(),this.drawAxes(),this.drawDataPoints(),this.drawAlertIfNeeded()}drawProbabilityBackground(){const ctx=this.ctx,gradient=ctx.createLinearGradient(40,0,560,0);gradient.addColorStop(0,"rgba(52, 152, 219, 0.15)"),gradient.addColorStop(.5,"rgba(255, 255, 255, 0.1)"),gradient.addColorStop(1,"rgba(231, 76, 60, 0.15)"),ctx.fillStyle=gradient,ctx.fillRect(40,40,520,420)}drawThresholdLine(){const x1_threshold=(Math.log(this.threshold/(1-this.threshold))-this.bias)/this.weights[0],canvasX=this.worldToCanvas(x1_threshold,0)[0],ctx=this.ctx;ctx.strokeStyle="#e74c3c",ctx.lineWidth=3,ctx.setLineDash([10,5]),ctx.beginPath(),ctx.moveTo(canvasX,0),ctx.lineTo(canvasX,500),ctx.stroke(),ctx.setLineDash([]),ctx.fillStyle="#e74c3c",ctx.font="bold 14px sans-serif",ctx.fillText(`Threshold = ${this.threshold.toFixed(2)}`,canvasX+10,30)}drawAxes(){const ctx=this.ctx;ctx.strokeStyle="#34495e",ctx.lineWidth=2;const y0=this.worldToCanvas(0,0)[1];ctx.beginPath(),ctx.moveTo(0,y0),ctx.lineTo(600,y0),ctx.stroke();const x0=this.worldToCanvas(0,0)[0];ctx.beginPath(),ctx.moveTo(x0,0),ctx.lineTo(x0,500),ctx.stroke()}drawDataPoints(){const ctx=this.ctx;this.data.forEach((point,i)=>{const[cx,cy]=this.worldToCanvas(point.x[0],point.x[1]),yTrue=point.y,yPred=this.probabilities[i]>=this.threshold?1:0;let type;type=1===yTrue&&1===yPred?"tp":0===yTrue&&0===yPred?"tn":0===yTrue&&1===yPred?"fp":"fn";let alpha=1;this.hoveredCell&&this.hoveredCell!==type&&(alpha=.2);const colors={tp:"#27ae60",tn:"#3498db",fp:"#e67e22",fn:"#9b59b6"};if(ctx.globalAlpha=alpha,0===yTrue?(ctx.beginPath(),ctx.arc(cx,cy,6,0,2*Math.PI),ctx.fillStyle=colors[type],ctx.fill(),ctx.strokeStyle="#2c3e50",ctx.lineWidth=1.5,ctx.stroke()):(ctx.beginPath(),ctx.moveTo(cx,cy-7),ctx.lineTo(cx-7,cy+7),ctx.lineTo(cx+7,cy+7),ctx.closePath(),ctx.fillStyle=colors[type],ctx.fill(),ctx.strokeStyle="#2c3e50",ctx.lineWidth=1.5,ctx.stroke()),"fp"===type||"fn"===type){ctx.strokeStyle="#c0392b",ctx.lineWidth=2.5;const xSize=5;ctx.beginPath(),ctx.moveTo(cx-xSize,cy-xSize),ctx.lineTo(cx+xSize,cy+xSize),ctx.moveTo(cx+xSize,cy-xSize),ctx.lineTo(cx-xSize,cy+xSize),ctx.stroke()}ctx.globalAlpha=1})}drawAlertIfNeeded(){const metrics=this.computeMetrics();if(metrics.accuracy>=.95&&metrics.sensitivity<=.1){const ctx=this.ctx,text="⚠️ High accuracy due to class imbalance — model missing most positive cases!";ctx.font="bold 13px sans-serif",ctx.textAlign="center";const textWidth=ctx.measureText(text).width,textHeight=18,padding=10,centerX=300,topY=25,boxX=centerX-textWidth/2-padding,boxY=topY-textHeight/2-padding/2,boxWidth=textWidth+2*padding,boxHeight=textHeight+padding,radius=4;ctx.fillStyle="rgba(255, 243, 205, 0.95)",ctx.strokeStyle="#ffc107",ctx.lineWidth=2,ctx.beginPath(),ctx.moveTo(boxX+radius,boxY),ctx.lineTo(boxX+boxWidth-radius,boxY),ctx.quadraticCurveTo(boxX+boxWidth,boxY,boxX+boxWidth,boxY+radius),ctx.lineTo(boxX+boxWidth,boxY+boxHeight-radius),ctx.quadraticCurveTo(boxX+boxWidth,boxY+boxHeight,boxX+boxWidth-radius,boxY+boxHeight),ctx.lineTo(boxX+radius,boxY+boxHeight),ctx.quadraticCurveTo(boxX,boxY+boxHeight,boxX,boxY+boxHeight-radius),ctx.lineTo(boxX,boxY+radius),ctx.quadraticCurveTo(boxX,boxY,boxX+radius,boxY),ctx.closePath(),ctx.fill(),ctx.stroke(),ctx.fillStyle="#856404",ctx.fillText(text,centerX,topY+6),ctx.textAlign="left"}}worldToCanvas(x,y){return[40+(x+4)/8*520,40+(3-y)/6*420]}}document.addEventListener("DOMContentLoaded",()=>{new MetricsDemo});
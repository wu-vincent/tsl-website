class PerceptronDemo{constructor(){this.plotCanvas=document.getElementById("plotCanvas"),this.plotCtx=this.plotCanvas.getContext("2d"),this.stepBtn=document.getElementById("stepBtn"),this.resetBtn=document.getElementById("resetBtn"),this.clearBtn=document.getElementById("clearBtn"),this.class0Btn=document.getElementById("class0Btn"),this.class1Btn=document.getElementById("class1Btn"),this.datasetBoxes=document.querySelectorAll(".dataset-box"),this.etaSlider=new ParamSlider("paramslider-eta",{inputId:"eta",label:"$\\eta$ (learning rate)",min:.01,max:1,step:.01,value:.1,fineTuneStep:.01,onChange:()=>this.render()}),this.historyScroll=document.getElementById("historyScroll"),this.historyEpochRow=document.querySelector(".history-row-epoch"),this.historyErrorsRow=document.querySelector(".history-row-errors"),this.historyBeta0Row=document.querySelector(".history-row-beta0"),this.historyBeta1Row=document.querySelector(".history-row-beta1"),this.historyBeta2Row=document.querySelector(".history-row-beta2"),this.historyUpdatesRow=document.querySelector(".history-row-updates"),this.state={beta0:0,beta1:0,beta2:0,eta:.1,epoch:0,converged:!1,lastErrors:0,lastUpdates:0},this.dataPoints=[],this.selectedClass=0,this.plotBounds={xMin:-5,xMax:5,yMin:-5,yMax:5},this.misclassifiedIndices=[],this.configurePlotCanvas(),this.setupEventListeners(),this.initializePlotChart(),this.infotab=new InfoTab,requestAnimationFrame(()=>{this.loadDataset("clean")})}configurePlotCanvas(){const{ctx:ctx,displayWidth:displayWidth,displayHeight:displayHeight}=CanvasHelper.setupCanvas(this.plotCanvas,{ctx:this.plotCtx,scaleContext:!1,applyStyle:!1,enableSmoothing:!1,resizeCanvas:!1});this.plotCtx=ctx,this.plotWidth=displayWidth,this.plotHeight=displayHeight}initializePlotChart(){this.plotChart=new Chart(this.plotCanvas.getContext("2d"),{type:"scatter",data:{datasets:[{label:"Class 0 Region",data:[],type:"line",backgroundColor:"rgba(52, 152, 219, 0.2)",borderColor:"rgba(52, 152, 219, 0.3)",borderWidth:1,pointRadius:0,fill:!0,tension:0,order:10,showLine:!0},{label:"Class 1 Region",data:[],type:"line",backgroundColor:"rgba(231, 76, 60, 0.2)",borderColor:"rgba(231, 76, 60, 0.3)",borderWidth:1,pointRadius:0,fill:!0,tension:0,order:10,showLine:!0},{label:"Class 0",data:[],backgroundColor:"#3498db",borderColor:"#2980b9",borderWidth:2,pointRadius:6,pointHoverRadius:8,order:1},{label:"Class 1",data:[],backgroundColor:"#e74c3c",borderColor:"#c0392b",borderWidth:2,pointRadius:6,pointHoverRadius:8,order:1},{label:"Misclassified",data:[],backgroundColor:"rgba(241, 196, 15, 0.5)",borderColor:"#f39c12",borderWidth:3,pointRadius:10,pointHoverRadius:12,pointStyle:"circle",order:0},{label:"Decision Boundary",data:[],type:"line",borderColor:"#2c3e50",backgroundColor:"transparent",borderWidth:3,pointRadius:0,fill:!1,tension:0,order:2}]},options:{responsive:!0,maintainAspectRatio:!1,animation:!1,resizeDelay:0,plugins:{legend:{display:!0,position:"top",labels:{filter:function(item,chart){return!item.text.includes("Region")}}},tooltip:{filter:function(tooltipItem){return tooltipItem.datasetIndex>=2},callbacks:{label:function(context){return context.datasetIndex>=2&&context.datasetIndex<=4?`(${context.parsed.x.toFixed(2)}, ${context.parsed.y.toFixed(2)})`:context.dataset.label}}}},scales:{x:{type:"linear",position:"bottom",min:this.plotBounds.xMin,max:this.plotBounds.xMax,grid:{color:"#e0e0e0"},title:{display:!0,text:"x₁",font:{size:14,weight:"bold"}}},y:{min:this.plotBounds.yMin,max:this.plotBounds.yMax,grid:{color:"#e0e0e0"},title:{display:!0,text:"x₂",font:{size:14,weight:"bold"}}}},onClick:(event,activeElements,chart)=>{this.handleCanvasClick(event,chart)}},plugins:[{id:"regionPlugin",beforeDatasetsDraw:chart=>{const ctx=chart.ctx,chartArea=chart.chartArea,xScale=chart.scales.x,yScale=chart.scales.y,class0RegionData=chart.data.datasets[0].data,class1RegionData=chart.data.datasets[1].data;class0RegionData&&class0RegionData.length>0&&(ctx.save(),ctx.beginPath(),ctx.rect(chartArea.left,chartArea.top,chartArea.right-chartArea.left,chartArea.bottom-chartArea.top),ctx.clip(),ctx.fillStyle="rgba(52, 152, 219, 0.2)",ctx.beginPath(),class0RegionData.forEach((point,index)=>{const x=xScale.getPixelForValue(point.x),y=yScale.getPixelForValue(point.y);0===index?ctx.moveTo(x,y):ctx.lineTo(x,y)}),ctx.closePath(),ctx.fill(),ctx.restore()),class1RegionData&&class1RegionData.length>0&&(ctx.save(),ctx.beginPath(),ctx.rect(chartArea.left,chartArea.top,chartArea.right-chartArea.left,chartArea.bottom-chartArea.top),ctx.clip(),ctx.fillStyle="rgba(231, 76, 60, 0.2)",ctx.beginPath(),class1RegionData.forEach((point,index)=>{const x=xScale.getPixelForValue(point.x),y=yScale.getPixelForValue(point.y);0===index?ctx.moveTo(x,y):ctx.lineTo(x,y)}),ctx.closePath(),ctx.fill(),ctx.restore())}}]})}setupEventListeners(){this.stepBtn.addEventListener("click",()=>this.step()),this.resetBtn.addEventListener("click",()=>this.reset()),this.clearBtn.addEventListener("click",()=>this.clearData()),this.datasetBoxes.forEach(box=>{box.addEventListener("click",()=>{const dataset=box.getAttribute("data-dataset");this.datasetBoxes.forEach(b=>b.classList.remove("active")),box.classList.add("active"),this.loadDataset(dataset)})}),this.class0Btn.addEventListener("click",()=>this.selectClass(0)),this.class1Btn.addEventListener("click",()=>this.selectClass(1))}selectClass(classLabel){this.selectedClass=classLabel,this.class0Btn.classList.toggle("active",0===classLabel),this.class1Btn.classList.toggle("active",1===classLabel)}handleCanvasClick(event,chart){const canvasPosition=Chart.helpers.getRelativePosition(event,chart),x1=chart.scales.x.getValueForPixel(canvasPosition.x),x2=chart.scales.y.getValueForPixel(canvasPosition.y);this.dataPoints.push({x1:x1,x2:x2,label:this.selectedClass}),this.render()}loadDataset(type){if(this.clearData(),"clean"===type){this.dataPoints=[];const margin=.5,range={min:-4,max:4},getRandom=(min,max)=>Math.random()*(max-min)+min;let class0Count=0;for(;class0Count<12;){const x1=getRandom(range.min,range.max),x2=getRandom(range.min,range.max);x1+x2<-margin&&(this.dataPoints.push({x1:x1,x2:x2,label:0}),class0Count++)}let class1Count=0;for(;class1Count<12;){const x1=getRandom(range.min,range.max),x2=getRandom(range.min,range.max);x1+x2>margin&&(this.dataPoints.push({x1:x1,x2:x2,label:1}),class1Count++)}}else if("xor"===type){this.dataPoints=[];for(let i=0;i<6;i++)this.dataPoints.push({x1:-1.6*Math.random()-2.2,x2:2+1.8*Math.random(),label:0});for(let i=0;i<6;i++)this.dataPoints.push({x1:2.2+1.6*Math.random(),x2:1.8*Math.random()-3.8,label:0});for(let i=0;i<6;i++)this.dataPoints.push({x1:2.2+1.6*Math.random(),x2:2+1.8*Math.random(),label:1});for(let i=0;i<6;i++)this.dataPoints.push({x1:-1.6*Math.random()-2.2,x2:1.8*Math.random()-3.8,label:1})}this.reset()}clearData(){this.dataPoints=[],this.reset()}reset(){this.state.beta0=.2*(Math.random()-.5),this.state.beta1=.2*(Math.random()-.5),this.state.beta2=.2*(Math.random()-.5),this.state.epoch=0,this.state.converged=!1,this.state.lastErrors=0,this.state.lastUpdates=0,this.misclassifiedIndices=[],this.clearHistoryTable(),this.addHistoryColumn(0,"—",this.state.beta0,this.state.beta1,this.state.beta2,0),this.updateReadouts(),this.render()}clearHistoryTable(){[this.historyEpochRow,this.historyErrorsRow,this.historyBeta0Row,this.historyBeta1Row,this.historyBeta2Row,this.historyUpdatesRow].forEach(row=>{for(;row.children.length>1;)row.removeChild(row.lastChild)})}step(){if(this.state.converged)return;if(0===this.dataPoints.length)return void alert("Please add some data points first!");this.state.eta=this.etaSlider.getValue();let errors=0,updates=0;this.misclassifiedIndices=[];for(let i=0;i<this.dataPoints.length;i++){const point=this.dataPoints[i],prediction=this.state.beta0+this.state.beta1*point.x1+this.state.beta2*point.x2>=0?1:0,error=point.label-prediction;0!==error&&(errors++,updates++,this.misclassifiedIndices.push(i),this.state.beta0+=this.state.eta*error,this.state.beta1+=this.state.eta*error*point.x1,this.state.beta2+=this.state.eta*error*point.x2)}this.state.epoch++,this.state.lastErrors=errors,this.state.lastUpdates=updates,0===errors&&(this.state.converged=!0),this.addHistoryColumn(this.state.epoch,errors,this.state.beta0,this.state.beta1,this.state.beta2,updates),this.updateReadouts(),this.render()}addHistoryColumn(epoch,errors,beta0,beta1,beta2,updates){document.querySelectorAll(".history-table td.current-iteration").forEach(cell=>{cell.classList.remove("current-iteration")});const epochCell=document.createElement("td");epochCell.textContent=epoch,epochCell.classList.add("current-iteration"),this.historyEpochRow.appendChild(epochCell);const errorsCell=document.createElement("td");errorsCell.textContent="—"===errors?"—":errors,errorsCell.classList.add("current-iteration"),0===errors&&"—"!==errors&&(errorsCell.style.fontWeight="bold",errorsCell.style.color="#27ae60"),this.historyErrorsRow.appendChild(errorsCell);const beta0Cell=document.createElement("td");beta0Cell.textContent=beta0.toFixed(3),beta0Cell.classList.add("current-iteration"),this.historyBeta0Row.appendChild(beta0Cell);const beta1Cell=document.createElement("td");beta1Cell.textContent=beta1.toFixed(3),beta1Cell.classList.add("current-iteration"),this.historyBeta1Row.appendChild(beta1Cell);const beta2Cell=document.createElement("td");beta2Cell.textContent=beta2.toFixed(3),beta2Cell.classList.add("current-iteration"),this.historyBeta2Row.appendChild(beta2Cell);const updatesCell=document.createElement("td");updatesCell.textContent=updates,updatesCell.classList.add("current-iteration"),this.historyUpdatesRow.appendChild(updatesCell),this.historyScroll.scrollLeft=this.historyScroll.scrollWidth}updateReadouts(){}render(){if(!this.plotChart)return;const class0Points=[],class1Points=[],misclassifiedPoints=[];this.dataPoints.forEach((point,idx)=>{const dataPoint={x:point.x1,y:point.x2};(this.state.beta0+this.state.beta1*point.x1+this.state.beta2*point.x2>=0?1:0)!==point.label?misclassifiedPoints.push(dataPoint):0===point.label?class0Points.push(dataPoint):class1Points.push(dataPoint)});const boundaryPoints=[],class0Region=[],class1Region=[];if(Math.abs(this.state.beta2)>1e-5){const x1_start=this.plotBounds.xMin,x1_end=this.plotBounds.xMax,x2_start=-(this.state.beta0+this.state.beta1*x1_start)/this.state.beta2,x2_end=-(this.state.beta0+this.state.beta1*x1_end)/this.state.beta2;boundaryPoints.push({x:x1_start,y:x2_start}),boundaryPoints.push({x:x1_end,y:x2_end}),this.state.beta2>0?(class0Region.push({x:x1_start,y:this.plotBounds.yMin},{x:x1_end,y:this.plotBounds.yMin},{x:x1_end,y:x2_end},{x:x1_start,y:x2_start}),class1Region.push({x:x1_start,y:x2_start},{x:x1_end,y:x2_end},{x:x1_end,y:this.plotBounds.yMax},{x:x1_start,y:this.plotBounds.yMax})):(class1Region.push({x:x1_start,y:this.plotBounds.yMin},{x:x1_end,y:this.plotBounds.yMin},{x:x1_end,y:x2_end},{x:x1_start,y:x2_start}),class0Region.push({x:x1_start,y:x2_start},{x:x1_end,y:x2_end},{x:x1_end,y:this.plotBounds.yMax},{x:x1_start,y:this.plotBounds.yMax}))}else if(Math.abs(this.state.beta1)>1e-5){const x1_pos=-this.state.beta0/this.state.beta1;boundaryPoints.push({x:x1_pos,y:this.plotBounds.yMin}),boundaryPoints.push({x:x1_pos,y:this.plotBounds.yMax}),this.state.beta1>0?(class0Region.push({x:this.plotBounds.xMin,y:this.plotBounds.yMin},{x:x1_pos,y:this.plotBounds.yMin},{x:x1_pos,y:this.plotBounds.yMax},{x:this.plotBounds.xMin,y:this.plotBounds.yMax}),class1Region.push({x:x1_pos,y:this.plotBounds.yMin},{x:this.plotBounds.xMax,y:this.plotBounds.yMin},{x:this.plotBounds.xMax,y:this.plotBounds.yMax},{x:x1_pos,y:this.plotBounds.yMax})):(class1Region.push({x:this.plotBounds.xMin,y:this.plotBounds.yMin},{x:x1_pos,y:this.plotBounds.yMin},{x:x1_pos,y:this.plotBounds.yMax},{x:this.plotBounds.xMin,y:this.plotBounds.yMax}),class0Region.push({x:x1_pos,y:this.plotBounds.yMin},{x:this.plotBounds.xMax,y:this.plotBounds.yMin},{x:this.plotBounds.xMax,y:this.plotBounds.yMax},{x:x1_pos,y:this.plotBounds.yMax}))}else boundaryPoints.push({x:this.plotBounds.xMin,y:0}),boundaryPoints.push({x:this.plotBounds.xMax,y:0}),class0Region.push({x:this.plotBounds.xMin,y:this.plotBounds.yMin},{x:this.plotBounds.xMax,y:this.plotBounds.yMin},{x:this.plotBounds.xMax,y:0},{x:this.plotBounds.xMin,y:0}),class1Region.push({x:this.plotBounds.xMin,y:0},{x:this.plotBounds.xMax,y:0},{x:this.plotBounds.xMax,y:this.plotBounds.yMax},{x:this.plotBounds.xMin,y:this.plotBounds.yMax});this.plotChart.data.datasets[0].data=class0Region,this.plotChart.data.datasets[1].data=class1Region,this.plotChart.data.datasets[2].data=class0Points,this.plotChart.data.datasets[3].data=class1Points,this.plotChart.data.datasets[4].data=misclassifiedPoints,this.plotChart.data.datasets[5].data=boundaryPoints,this.plotChart.update("none")}}document.addEventListener("DOMContentLoaded",()=>{window.demo=new PerceptronDemo});